<!DOCTYPE html>
<html>
<head>
    <title>Mobile Sync</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        textarea { width: 100%; height: 100px; margin-top: 10px; }
        .status { padding: 10px; background: #eee; border-radius: 4px; }
    </style>
</head>
<body>
    <h2>Mobile Clipboard</h2>
    <div id="status" class="status">Disconnected</div>
    
    <div id="join-screen">
        <input type="text" id="pin" placeholder="Enter PIN from Desktop" />
        <button onclick="join()">Join</button>
    </div>

    <div id="sync-screen" style="display:none;">
        <textarea id="clip-area" placeholder="Copy/Paste here to sync"></textarea>
        <p>Text copied here sends to Desktop.</p>
        <p>Text copied on Desktop appears here.</p>
    </div>

    <script>
        let ws;
        let lastReceivedText = '';
        
        function join() {
            const pin = document.getElementById('pin').value;
            const host = window.location.host; 
            ws = new WebSocket('ws://' + host);

            ws.onopen = () => {
                ws.send(JSON.stringify({ type: 'JOIN_ROOM', payload: { pin, deviceId: 'Mobile-' + Date.now() } }));
                document.getElementById('status').innerText = "âœ… Connected!";
                document.getElementById('join-screen').style.display = 'none';
                document.getElementById('sync-screen').style.display = 'block';
            };

            ws.onmessage = async (event) => {
                const msg = JSON.parse(event.data);
                if(msg.type === 'CLIPBOARD_PUSH') {
                    const text = msg.payload;
                    lastReceivedText = text;
                    document.getElementById('clip-area').value = text;
                    
                    // ðŸ“± COPY TO DEVICE CLIPBOARD using Clipboard API
                    try {
                        await navigator.clipboard.writeText(text);
                        console.log("ðŸ“‹ Copied to clipboard:", text.substring(0, 50));
                    } catch (err) {
                        console.error("Clipboard API failed:", err);
                        // Fallback: at least the textarea is updated
                    }
                }
            };
            
            ws.onerror = () => {
                document.getElementById('status').innerText = "âŒ Connection Error";
            };

            ws.onclose = () => {
                document.getElementById('status').innerText = "ðŸ”´ Disconnected";
            };
            
            const area = document.getElementById('clip-area');
            area.addEventListener('input', () => {
                const text = area.value;
                // Only send if different from last received (prevent echo)
                if (text !== lastReceivedText) {
                    ws.send(JSON.stringify({ type: 'CLIPBOARD_PUSH', payload: text }));
                }
            });
        }
        
        // Auto-join if PIN is in URL
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('pin')) {
            document.getElementById('pin').value = urlParams.get('pin');
            join();
        }
    </script>
</body>
</html>